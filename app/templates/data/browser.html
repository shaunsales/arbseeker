{% extends "base.html" %}

{% set active_tab = "data" %}
{% block title %}Data Browser - Strategy Lab{% endblock %}

{% block content %}
<div class="flex gap-6">
    <!-- Sidebar: Data Tree + Download Form -->
    <div class="w-80 flex-shrink-0">
        <!-- Download Form -->
        <div class="bg-gray-800 rounded-lg p-4 mb-4 border border-gray-700">
            <h3 class="font-semibold mb-3">Download Data</h3>
            <form id="download-form" class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Ticker</label>
                    <input type="text" name="ticker" value="BTCUSDT" 
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:border-blue-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Interval</label>
                    <select name="interval" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:border-blue-500 focus:outline-none">
                        {% for interval in intervals %}
                        <option value="{{ interval }}" {% if interval == "1h" %}selected{% endif %}>{{ interval }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Year</label>
                    <select name="year" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:border-blue-500 focus:outline-none">
                        {% for year in range(2020, 2027) %}
                        <option value="{{ year }}" {% if year == 2024 %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Market</label>
                    <select name="market" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:border-blue-500 focus:outline-none">
                        <option value="futures" selected>USDM Futures</option>
                        <option value="spot">Spot</option>
                    </select>
                </div>
                <button type="submit" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded transition">
                    Download
                </button>
            </form>
            
            <!-- Download Progress -->
            <div id="download-progress" class="hidden mt-3">
                <div class="flex items-center justify-between text-sm mb-1">
                    <span id="download-status" class="text-gray-400">Downloading...</span>
                    <span id="download-percent" class="text-blue-400">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="download-bar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
        </div>
        
        <!-- Data Tree -->
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <h3 class="font-semibold mb-3">Available Data</h3>
            <div id="data-tree" hx-get="/data/tree" hx-trigger="load" hx-swap="innerHTML">
                <div class="text-gray-500 text-sm">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Main: Data Preview -->
    <div class="flex-1">
        <div id="data-preview" class="bg-gray-800 rounded-lg p-6 border border-gray-700 min-h-[600px]">
            <div class="text-center text-gray-500 py-12">
                <div class="text-4xl mb-3">ðŸ“Š</div>
                <p>Select data from the tree to preview</p>
                <p class="text-sm mt-2">Or download new data using the form</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Download form handler
document.getElementById('download-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const data = {
        venue: 'binance',
        market: form.market.value,
        ticker: form.ticker.value.toUpperCase(),
        interval: form.interval.value,
        year: parseInt(form.year.value),
    };
    
    // Show progress
    const progressDiv = document.getElementById('download-progress');
    const statusEl = document.getElementById('download-status');
    const percentEl = document.getElementById('download-percent');
    const barEl = document.getElementById('download-bar');
    
    progressDiv.classList.remove('hidden');
    statusEl.textContent = 'Starting...';
    percentEl.textContent = '0%';
    barEl.style.width = '0%';
    
    try {
        // Start download
        const response = await fetch('/data/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        
        const result = await response.json();
        const jobId = result.job_id;
        
        // Poll for status
        const pollStatus = async () => {
            const statusResponse = await fetch(`/data/download/status/${jobId}`);
            const status = await statusResponse.json();
            
            statusEl.textContent = status.message || 'Downloading...';
            percentEl.textContent = `${status.progress}%`;
            barEl.style.width = `${status.progress}%`;
            
            if (status.status === 'running') {
                setTimeout(pollStatus, 500);
            } else if (status.status === 'complete') {
                statusEl.textContent = 'Complete!';
                barEl.classList.remove('bg-blue-600');
                barEl.classList.add('bg-green-600');
                // Refresh tree
                htmx.trigger('#data-tree', 'load');
                // Hide progress after delay
                setTimeout(() => progressDiv.classList.add('hidden'), 2000);
            } else if (status.status === 'error') {
                statusEl.textContent = `Error: ${status.message}`;
                barEl.classList.remove('bg-blue-600');
                barEl.classList.add('bg-red-600');
            }
        };
        
        pollStatus();
    } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
        barEl.classList.add('bg-red-600');
    }
});

// Load preview when clicking on data item
function loadPreview(venue, market, ticker, interval) {
    const url = `/data/preview/${venue}/${market}/${ticker}/${interval}`;
    htmx.ajax('GET', url, '#data-preview');
}
</script>
{% endblock %}
