<!-- Basis Preview -->
<div class="space-y-4">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-xl font-bold">{{ ticker }} / {{ interval }}</h2>
            <div class="flex items-center gap-3 mt-1">
                <span class="text-gray-400 text-sm">{{ stats.start }} → {{ stats.end }}</span>
                <span class="text-gray-600">|</span>
                <span class="text-sm text-gray-300">{{ "{:,}".format(stats.bars) }} bars</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span class="px-2 py-1 bg-green-900 text-green-300 rounded text-xs">
                {{ "{:.1f}".format(stats.quality_pct) }}% quality
            </span>
        </div>
    </div>

    {% for venue in quote_venues %}
    {% set vs = venue_stats[venue] %}

    <!-- Distribution Stats -->
    <div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">{{ venue }} — Distribution</div>
        <div class="grid grid-cols-4 gap-2">
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">Mean</div>
                <div class="text-base font-semibold">{{ "{:.1f}".format(vs.mean_bps) }} bps</div>
            </div>
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">Std Dev</div>
                <div class="text-base font-semibold">{{ "{:.1f}".format(vs.std_bps) }} bps</div>
            </div>
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">Min</div>
                <div class="text-base font-semibold text-red-400">{{ "{:.1f}".format(vs.min_bps) }} bps</div>
            </div>
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">Max</div>
                <div class="text-base font-semibold text-green-400">{{ "{:.1f}".format(vs.max_bps) }} bps</div>
            </div>
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">Median</div>
                <div class="text-base font-semibold">{{ "{:.1f}".format(vs.median_bps) }} bps</div>
            </div>
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">Skewness</div>
                <div class="text-base font-semibold">{{ "{:.2f}".format(vs.skewness) }}</div>
            </div>
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">% Positive</div>
                <div class="text-base font-semibold">{{ "{:.1f}".format(vs.pct_positive) }}%</div>
            </div>
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">Current Z-score</div>
                <div class="text-base font-semibold {% if vs.zscore > 1.5 %}text-red-400{% elif vs.zscore < -1.5 %}text-green-400{% endif %}">
                    {{ "{:+.2f}".format(vs.zscore) }}σ
                </div>
            </div>
        </div>
    </div>

    <!-- Mean Reversion Stats -->
    <div>
        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">{{ venue }} — Mean Reversion</div>
        <div class="grid grid-cols-4 gap-2">
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">ADF p-value</div>
                <div class="text-base font-semibold {% if vs.adf_pvalue is not none and vs.adf_pvalue < 0.05 %}text-green-400{% elif vs.adf_pvalue is not none %}text-red-400{% endif %}">
                    {% if vs.adf_pvalue is not none %}
                    {{ "{:.4f}".format(vs.adf_pvalue) }}
                    {% else %}—{% endif %}
                </div>
                <div class="text-xs mt-0.5 {% if vs.adf_stationary %}text-green-500{% else %}text-gray-500{% endif %}">
                    {% if vs.adf_stationary %}Stationary{% elif vs.adf_stationary is not none %}Non-stationary{% endif %}
                </div>
            </div>
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">Half-Life</div>
                <div class="text-base font-semibold">
                    {% if vs.half_life_days is not none %}
                        {% if vs.half_life_days < 1 %}
                        {{ "{:.1f}".format(vs.half_life_days * 24) }} hrs
                        {% else %}
                        {{ "{:.1f}".format(vs.half_life_days) }} days
                        {% endif %}
                    {% else %}—{% endif %}
                </div>
                {% if vs.half_life_bars is not none %}
                <div class="text-xs text-gray-500 mt-0.5">{{ "{:.0f}".format(vs.half_life_bars) }} bars</div>
                {% endif %}
            </div>
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">Hurst Exponent</div>
                <div class="text-base font-semibold {% if vs.hurst_regime == 'mean-reverting' %}text-green-400{% elif vs.hurst_regime == 'trending' %}text-yellow-400{% endif %}">
                    {% if vs.hurst_exponent is not none %}
                    {{ "{:.3f}".format(vs.hurst_exponent) }}
                    {% else %}—{% endif %}
                </div>
                {% if vs.hurst_regime %}
                <div class="text-xs text-gray-500 mt-0.5">{{ vs.hurst_regime }}</div>
                {% endif %}
            </div>
            <div class="bg-gray-700 rounded p-2.5">
                <div class="text-gray-400 text-xs">Mean Crossings</div>
                <div class="text-base font-semibold">
                    {% if vs.mean_crossings_per_day is not none %}
                    {{ "{:.1f}".format(vs.mean_crossings_per_day) }}/day
                    {% else %}—{% endif %}
                </div>
                {% if vs.mean_crossings_total is not none %}
                <div class="text-xs text-gray-500 mt-0.5">{{ "{:,}".format(vs.mean_crossings_total) }} total</div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Charts -->
    <div id="basis-chart" class="bg-gray-900 rounded" style="height: 300px;"></div>
    <div id="price-chart" class="bg-gray-900 rounded" style="height: 200px;"></div>
</div>

<script>
setTimeout(function() {
    const data = {{ chart_data | safe }};
    
    if (!data || !data.timestamps || data.timestamps.length === 0) {
        console.error('No chart data');
        return;
    }
    
    // Clear existing charts
    document.getElementById('basis-chart').innerHTML = '';
    document.getElementById('price-chart').innerHTML = '';
    
    const chartOptions = {
        layout: {
            background: { type: 'solid', color: 'transparent' },
            textColor: '#9ca3af',
        },
        grid: {
            vertLines: { color: '#374151' },
            horzLines: { color: '#374151' },
        },
        rightPriceScale: { borderColor: '#374151' },
        timeScale: { borderColor: '#374151', timeVisible: true },
    };
    
    // Basis chart (bps)
    const basisChart = LightweightCharts.createChart(
        document.getElementById('basis-chart'),
        { ...chartOptions, height: 300 }
    );
    
    {% for venue in quote_venues %}
    const {{ venue }}_basis = basisChart.addLineSeries({
        color: '#f59e0b',
        lineWidth: 1.5,
        title: '{{ venue }} basis (bps)',
    });
    {{ venue }}_basis.setData(data.timestamps.map((t, i) => ({
        time: Math.floor(new Date(t).getTime() / 1000),
        value: data.{{ venue }}_basis_bps[i],
    })));
    {% endfor %}
    
    // Add zero line
    const zeroLine = basisChart.addLineSeries({
        color: '#6b7280',
        lineWidth: 1,
        lineStyle: 2,
    });
    zeroLine.setData(data.timestamps.map((t) => ({
        time: Math.floor(new Date(t).getTime() / 1000),
        value: 0,
    })));
    
    // Price chart
    const priceChart = LightweightCharts.createChart(
        document.getElementById('price-chart'),
        { ...chartOptions, height: 200 }
    );
    
    const baseLine = priceChart.addLineSeries({
        color: '#3b82f6',
        lineWidth: 1.5,
        title: 'Base',
    });
    baseLine.setData(data.timestamps.map((t, i) => ({
        time: Math.floor(new Date(t).getTime() / 1000),
        value: data.base_price[i],
    })));
    
    {% for venue in quote_venues %}
    const {{ venue }}_price = priceChart.addLineSeries({
        color: '#22c55e',
        lineWidth: 1.5,
        title: '{{ venue }}',
    });
    {{ venue }}_price.setData(data.timestamps.map((t, i) => ({
        time: Math.floor(new Date(t).getTime() / 1000),
        value: data.{{ venue }}_price[i],
    })));
    {% endfor %}
    
    // Sync time scales
    basisChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
        if (range) priceChart.timeScale().setVisibleLogicalRange(range);
    });
    priceChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
        if (range) basisChart.timeScale().setVisibleLogicalRange(range);
    });
    
    // Fit content
    basisChart.timeScale().fitContent();
    priceChart.timeScale().fitContent();
}, 10);
</script>
