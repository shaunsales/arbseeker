{% extends "base.html" %}

{% set active_tab = "basis" %}
{% block title %}Basis Builder - Strategy Lab{% endblock %}

{% block main_class %}flex h-[calc(100vh-3.5rem)]{% endblock %}

{% block content %}
<!-- Sidebar -->
<aside class="w-80 flex-shrink-0 bg-gray-800 border-r border-gray-700 flex flex-col overflow-hidden">
    <div class="px-4 py-3 border-b border-gray-700 flex-shrink-0">
        <span class="text-sm font-semibold text-gray-300 uppercase tracking-wide">Basis Builder</span>
    </div>
    <div class="flex-1 overflow-y-auto">

        <!-- Step 1: Base Venue -->
        <div class="border-b border-gray-700">
            <div onclick="toggleSection('base')" class="flex items-center justify-between px-4 py-2.5 cursor-pointer hover:bg-gray-750">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-gray-500">1</span>
                    <span class="text-sm font-medium text-gray-300">Base (Reference)</span>
                </div>
                <span id="base-summary" class="text-xs text-blue-400 truncate max-w-[120px]"></span>
            </div>
            <div id="section-base" class="px-4 pb-3 space-y-2">
                <select id="base-venue" onchange="onBaseVenueChange()" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm">
                    <option value="">Venue...</option>
                    {% for venue, markets in data_tree.items() %}
                    {% for market in markets.keys() %}
                    <option value="{{ venue }}|{{ market }}">{{ venue }} ({{ market }})</option>
                    {% endfor %}
                    {% endfor %}
                </select>
                <select id="base-ticker" onchange="onSelectionChange()" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm">
                    <option value="">Ticker...</option>
                </select>
            </div>
        </div>

        <!-- Step 2: Quote Venue -->
        <div class="border-b border-gray-700">
            <div onclick="toggleSection('quote')" class="flex items-center justify-between px-4 py-2.5 cursor-pointer hover:bg-gray-750">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-gray-500">2</span>
                    <span class="text-sm font-medium text-gray-300">Quote (Comparison)</span>
                </div>
                <span id="quote-summary" class="text-xs text-blue-400 truncate max-w-[120px]"></span>
            </div>
            <div id="section-quote" class="px-4 pb-3 space-y-2">
                <select id="quote-venue" onchange="onQuoteVenueChange()" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm">
                    <option value="">Venue...</option>
                    {% for venue, markets in data_tree.items() %}
                    {% for market in markets.keys() %}
                    <option value="{{ venue }}|{{ market }}">{{ venue }} ({{ market }})</option>
                    {% endfor %}
                    {% endfor %}
                </select>
                <select id="quote-ticker" onchange="onSelectionChange()" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm">
                    <option value="">Ticker...</option>
                </select>
            </div>
        </div>

        <!-- Step 3: Interval -->
        <div class="border-b border-gray-700">
            <div onclick="toggleSection('interval')" class="flex items-center justify-between px-4 py-2.5 cursor-pointer hover:bg-gray-750">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-gray-500">3</span>
                    <span class="text-sm font-medium text-gray-300">Interval</span>
                </div>
                <span id="interval-summary" class="text-xs text-blue-400"></span>
            </div>
            <div id="section-interval" class="px-4 pb-3">
                <div id="interval-pills" class="flex flex-wrap gap-1.5">
                    <span class="text-xs text-gray-500">Select base and quote first</span>
                </div>
            </div>
        </div>

        <!-- Step 4: Months -->
        <div class="border-b border-gray-700">
            <div onclick="toggleSection('months')" class="flex items-center justify-between px-4 py-2.5 cursor-pointer hover:bg-gray-750">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-gray-500">4</span>
                    <span class="text-sm font-medium text-gray-300">Months</span>
                </div>
                <span id="months-summary" class="text-xs text-blue-400"></span>
            </div>
            <div id="section-months" class="px-4 pb-3">
                <div id="month-pills" class="flex flex-wrap gap-1.5">
                    <span class="text-xs text-gray-500">Select interval first</span>
                </div>
                <div id="month-range-hint" class="hidden mt-2 text-xs text-gray-500">
                    Click to set start, click again to set end of range
                </div>
            </div>
        </div>

        <!-- Create Button -->
        <div class="px-4 py-3 border-b border-gray-700">
            <button id="create-btn" onclick="createBasis()" disabled
                    class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-medium py-2 px-4 rounded text-sm transition">
                Create Basis File
            </button>
            <div id="create-result" class="hidden mt-2 p-2 rounded text-xs"></div>
        </div>

        <!-- Existing Basis Files -->
        <div>
            <div onclick="toggleSection('existing')" class="flex items-center justify-between px-4 py-2.5 cursor-pointer hover:bg-gray-750">
                <span class="text-sm font-medium text-gray-400">Existing Files</span>
                <span class="text-xs text-gray-500">{{ basis_files | length }}</span>
            </div>
            <div id="section-existing" class="px-4 pb-3 text-sm select-none">
                {% if basis_files %}
                {% for ticker, intervals in basis_files.items() %}
                <div class="mb-1">
                    <div onclick="toggleNode(this)" class="flex items-center gap-1.5 px-1 py-0.5 rounded hover:bg-gray-700 cursor-pointer">
                        <span class="chevron text-gray-500 text-xs w-3">â–¶</span>
                        <span class="text-gray-300 font-medium">{{ ticker }}</span>
                    </div>
                    <div class="ml-4 hidden">
                        {% for interval, periods in intervals.items() %}
                        <div class="mb-0.5">
                            <div onclick="toggleNode(this)" class="flex items-center gap-1.5 px-1 py-0.5 rounded hover:bg-gray-700 cursor-pointer">
                                <span class="chevron text-gray-500 text-xs w-3">â–¶</span>
                                <button onclick="event.stopPropagation(); loadBasisPreview('{{ ticker }}','{{ interval }}')"
                                        class="text-blue-400 hover:text-blue-300 font-medium text-xs">{{ interval }}</button>
                            </div>
                            <div class="ml-4 hidden">
                                {% for period in periods %}
                                <button onclick="loadBasisPreview('{{ ticker }}','{{ interval }}','{{ period }}')"
                                        class="block w-full text-left px-2 py-0.5 rounded text-gray-400 hover:text-gray-200 hover:bg-gray-700 text-xs font-mono">
                                    {{ period }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <span class="text-xs text-gray-500">No basis files yet</span>
                {% endif %}
            </div>
        </div>

    </div>
</aside>

<!-- Main: Preview Area -->
<div class="flex-1 overflow-y-auto p-6">
    <div id="basis-preview" class="max-w-6xl mx-auto">
        <div class="text-center text-gray-500 py-20">
            <div class="text-4xl mb-3">ðŸ“ˆ</div>
            <p>Configure base and quote venues, then select an interval and months</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const dataTree = {{ data_tree | tojson | safe }};

// --- State ---
let state = {
    baseVenue: null, baseMarket: null, baseTicker: null,
    quoteVenue: null, quoteMarket: null, quoteTicker: null,
    interval: null,
    selectedMonths: [],   // contiguous selected months
    commonMonths: [],     // months available in both
};
let monthSelectStart = null; // for range selection

// --- Section toggle ---
function toggleSection(name) {
    const el = document.getElementById('section-' + name);
    if (el) el.classList.toggle('hidden');
}

function toggleNode(el) {
    const children = el.nextElementSibling;
    const chevron = el.querySelector('.chevron');
    if (children) {
        children.classList.toggle('hidden');
        if (chevron) chevron.textContent = children.classList.contains('hidden') ? 'â–¶' : 'â–¼';
    }
}

// --- Helpers ---
function getIntervals(venue, market, ticker) {
    try { return Object.keys(dataTree[venue][market][ticker]); } catch(e) { return []; }
}
function getPeriods(venue, market, ticker, interval) {
    try { return dataTree[venue][market][ticker][interval]; } catch(e) { return []; }
}

// --- Step 1: Base venue change ---
function onBaseVenueChange() {
    const val = document.getElementById('base-venue').value;
    const tickerSel = document.getElementById('base-ticker');
    tickerSel.innerHTML = '<option value="">Ticker...</option>';

    if (!val) { state.baseVenue = state.baseMarket = state.baseTicker = null; onSelectionChange(); return; }
    const [venue, market] = val.split('|');
    state.baseVenue = venue; state.baseMarket = market; state.baseTicker = null;

    const tickers = Object.keys(dataTree[venue]?.[market] || {});
    for (const t of tickers) tickerSel.innerHTML += `<option value="${t}">${t}</option>`;
    onSelectionChange();
}

// --- Step 2: Quote venue change ---
function onQuoteVenueChange() {
    const val = document.getElementById('quote-venue').value;
    const tickerSel = document.getElementById('quote-ticker');
    tickerSel.innerHTML = '<option value="">Ticker...</option>';

    if (!val) { state.quoteVenue = state.quoteMarket = state.quoteTicker = null; onSelectionChange(); return; }
    const [venue, market] = val.split('|');
    state.quoteVenue = venue; state.quoteMarket = market; state.quoteTicker = null;

    const tickers = Object.keys(dataTree[venue]?.[market] || {});
    for (const t of tickers) tickerSel.innerHTML += `<option value="${t}">${t}</option>`;
    onSelectionChange();
}

// --- Central selection change handler ---
function onSelectionChange() {
    state.baseTicker = document.getElementById('base-ticker').value || null;
    state.quoteTicker = document.getElementById('quote-ticker').value || null;

    // Update summaries
    document.getElementById('base-summary').textContent =
        state.baseTicker ? `${state.baseVenue} / ${state.baseTicker}` : '';
    document.getElementById('quote-summary').textContent =
        state.quoteTicker ? `${state.quoteVenue} / ${state.quoteTicker}` : '';

    updateIntervalPills();
}

// --- Step 3: Compute common intervals ---
function updateIntervalPills() {
    const container = document.getElementById('interval-pills');
    state.interval = null;
    state.selectedMonths = [];
    document.getElementById('interval-summary').textContent = '';
    document.getElementById('months-summary').textContent = '';

    if (!state.baseTicker || !state.quoteTicker) {
        container.innerHTML = '<span class="text-xs text-gray-500">Select base and quote first</span>';
        updateMonthPills();
        updateCreateButton();
        return;
    }

    const baseIntervals = new Set(getIntervals(state.baseVenue, state.baseMarket, state.baseTicker));
    const quoteIntervals = new Set(getIntervals(state.quoteVenue, state.quoteMarket, state.quoteTicker));
    const common = [...baseIntervals].filter(i => quoteIntervals.has(i));

    if (common.length === 0) {
        container.innerHTML = '<span class="text-xs text-red-400">No common intervals</span>';
        updateMonthPills();
        updateCreateButton();
        return;
    }

    container.innerHTML = '';
    for (const iv of common) {
        const btn = document.createElement('button');
        btn.textContent = iv;
        btn.className = 'px-2.5 py-1 rounded text-xs font-medium bg-gray-700 text-gray-300 hover:bg-gray-600 transition';
        btn.onclick = () => selectInterval(iv);
        container.appendChild(btn);
    }
    updateMonthPills();
    updateCreateButton();
}

function selectInterval(iv) {
    state.interval = iv;
    document.getElementById('interval-summary').textContent = iv;
    monthSelectStart = null;

    // Highlight selected
    document.querySelectorAll('#interval-pills button').forEach(btn => {
        if (btn.textContent === iv) {
            btn.className = 'px-2.5 py-1 rounded text-xs font-medium bg-blue-600 text-white transition';
        } else {
            btn.className = 'px-2.5 py-1 rounded text-xs font-medium bg-gray-700 text-gray-300 hover:bg-gray-600 transition';
        }
    });

    updateMonthPills();
    updateCreateButton();
}

// --- Step 4: Compute common months ---
function updateMonthPills() {
    const container = document.getElementById('month-pills');
    const hint = document.getElementById('month-range-hint');
    state.selectedMonths = [];
    state.commonMonths = [];

    if (!state.interval) {
        container.innerHTML = '<span class="text-xs text-gray-500">Select interval first</span>';
        hint.classList.add('hidden');
        updateCreateButton();
        return;
    }

    const basePeriods = new Set(getPeriods(state.baseVenue, state.baseMarket, state.baseTicker, state.interval));
    const quotePeriods = new Set(getPeriods(state.quoteVenue, state.quoteMarket, state.quoteTicker, state.interval));
    const common = [...basePeriods].filter(p => quotePeriods.has(p)).sort();
    state.commonMonths = common;

    if (common.length === 0) {
        container.innerHTML = '<span class="text-xs text-red-400">No common months</span>';
        hint.classList.add('hidden');
        updateCreateButton();
        return;
    }

    container.innerHTML = '';
    for (const m of common) {
        const btn = document.createElement('button');
        btn.textContent = m;
        btn.dataset.month = m;
        btn.className = 'month-pill px-2 py-1 rounded text-xs font-mono bg-gray-700 text-gray-300 hover:bg-gray-600 transition';
        btn.onclick = () => onMonthClick(m);
        container.appendChild(btn);
    }

    // Auto-select all by default
    state.selectedMonths = [...common];
    monthSelectStart = null;
    refreshMonthHighlights();
    hint.classList.remove('hidden');
    updateCreateButton();
}

function onMonthClick(month) {
    if (monthSelectStart === null) {
        // First click: set start
        monthSelectStart = month;
        state.selectedMonths = [month];
    } else {
        // Second click: set range
        const startIdx = state.commonMonths.indexOf(monthSelectStart);
        const endIdx = state.commonMonths.indexOf(month);
        const lo = Math.min(startIdx, endIdx);
        const hi = Math.max(startIdx, endIdx);
        state.selectedMonths = state.commonMonths.slice(lo, hi + 1);
        monthSelectStart = null;
    }
    refreshMonthHighlights();
    updateCreateButton();
}

function refreshMonthHighlights() {
    const sel = new Set(state.selectedMonths);
    document.querySelectorAll('.month-pill').forEach(btn => {
        if (sel.has(btn.dataset.month)) {
            btn.className = 'month-pill px-2 py-1 rounded text-xs font-mono bg-blue-600 text-white transition';
        } else {
            btn.className = 'month-pill px-2 py-1 rounded text-xs font-mono bg-gray-700 text-gray-300 hover:bg-gray-600 transition';
        }
    });
    if (state.selectedMonths.length > 0) {
        const first = state.selectedMonths[0];
        const last = state.selectedMonths[state.selectedMonths.length - 1];
        document.getElementById('months-summary').textContent =
            first === last ? first : `${first} â†’ ${last}`;
    } else {
        document.getElementById('months-summary').textContent = '';
    }
}

// --- Create button ---
function updateCreateButton() {
    const btn = document.getElementById('create-btn');
    btn.disabled = !(state.baseTicker && state.quoteTicker && state.interval && state.selectedMonths.length > 0);
}

async function createBasis() {
    const btn = document.getElementById('create-btn');
    const resultDiv = document.getElementById('create-result');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    const data = {
        base_venue: state.baseVenue,
        base_market: state.baseMarket,
        base_ticker: state.baseTicker,
        quote_venue: state.quoteVenue,
        quote_market: state.quoteMarket,
        quote_ticker: state.quoteTicker,
        quote_name: state.quoteVenue,
        interval: state.interval,
        periods: state.selectedMonths,
    };

    try {
        const resp = await fetch('/basis/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        const result = await resp.json();
        resultDiv.classList.remove('hidden');

        if (result.success) {
            resultDiv.className = 'mt-2 p-2 rounded text-xs bg-green-900 text-green-300';
            resultDiv.innerHTML = `âœ“ Created: ${result.bars} bars, ${result.coverage_pct.toFixed(1)}% coverage`;
            // Load preview of the created file
            loadBasisPreview(state.baseTicker, state.interval);
            setTimeout(() => location.reload(), 2000);
        } else {
            resultDiv.className = 'mt-2 p-2 rounded text-xs bg-red-900 text-red-300';
            resultDiv.innerHTML = `âœ— ${result.error}`;
        }
    } catch (e) {
        resultDiv.classList.remove('hidden');
        resultDiv.className = 'mt-2 p-2 rounded text-xs bg-red-900 text-red-300';
        resultDiv.innerHTML = `âœ— ${e.message}`;
    }
    btn.textContent = 'Create Basis File';
    updateCreateButton();
}

// --- Load basis preview ---
function loadBasisPreview(ticker, interval, period) {
    let url = `/basis/preview/${ticker}/${interval}`;
    if (period) url += `?period=${period}`;
    htmx.ajax('GET', url, '#basis-preview');
}
</script>
{% endblock %}
